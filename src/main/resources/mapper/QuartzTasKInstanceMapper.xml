<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="io.choerodon.asgard.infra.mapper.SagaInstanceMapper">

    <select id="selectLastTime" databaseId="mysql" resultType="java.util.Date">
     SELECT actual_start_time FROM asgard_quartz_task_instance
     WHERE task_id = #{taskId}
     ORDER BY CREATION_DATE DESC
     LIMIT 1
  </select>

    <select id="selectLastTime" databaseId="oracle" resultType="java.util.Date">
    <![CDATA[
      SELECT * FROM (
         SELECT actual_start_time FROM asgard_quartz_task_instance
         WHERE task_id = #{taskId}
         ORDER BY CREATION_DATE DESC
      ) WHERE ROWNUM <= 1
    ]]>
</select>

    <select id="countUnCompletedInstance"  resultType="java.lang.Integer">
        SELECT COUNT(*) FROM asgard_quartz_task_instance
        WHERE status != COMPLETED AND task_id = #{taskId}
    </select>

    <select id="fulltextSearch" resultType="io.choerodon.asgard.api.dto.ScheduleTaskInstanceDTO">
        SELECT
        aqti.id,
        aqti.status,
        aqt.name AS taskName,
        aqti.exception_message,
        aqti.planned_start_time ,
        aqti.actual_start_time,
        aqti.actual_last_time,
        aqti.planned_next_time
        FROM asgard_quartz_task_instance aqti
        LEFT JOIN asgard_quartz_task aqt
        ON aqti.task_id = aqt.id
        WHERE 1 = 1
        <if test="taskName != null">
            AND aqt.name = #{taskName}
        </if>
        <if test="status != null">
            AND aqti.status LIKE concat(concat('%',#{status}),'%')
        </if>

        <if test="exceptionMessage != null">
            AND aqti.exception_message LIKE concat(concat('%',#{exceptionMessage}),'%')
        </if>

        <if test="params != null">
            AND(
            aqt.name LIKE concat(concat('%',#{params}),'%') OR
            aqti.exception_messag LIKE concat(concat('%',#{params}),'%') OR
            aqti.status LIKE concat(concat('%',#{params}),'%')
            )
        </if>
    </select>

</mapper>
